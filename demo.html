<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>p2p Demo</title>
  <style>

  </style>
</head>

<body>
  <h1>p2p Demo</h1>
  <script type="module">
    import { Sender, Receiver } from './dist/p2p.esm.js';

    class MemoryDriver {
      constructor() {
        this._handlers = new Map();
      }
      on(namespace, handler) {
        const k = [].concat(namespace).join('.');
        if (!this._handlers.has(k)) {
          this._handlers.set(k, new Set());
        }
        this._handlers.get(k).add(handler);
      }
      off(namespace, handler) {
        const k = [].concat(namespace).join('.');
        this._handlers.get(k)?.delete(handler);
      }
      emit(namespace, msg) {
        const k = [].concat(namespace).join('.');
        const hs = this._handlers.get(k);
        if (hs) {
          for (const h of hs) {
            try { h(msg); } catch (e) { /* swallow */ }
          }
        }
      }
    }

    const driver = new MemoryDriver();
    const receiver = new Receiver({ driver });

    receiver.addEventListener('stream', (e) => {
      const { id, stream, metadata } = e.detail;
      console.log('remote stream from', id, metadata);

      // attach to a video element
      const video = document.createElement('video');
      video.autoplay = true;
      video.srcObject = stream;
      document.body.appendChild(video);
    });

    receiver.addEventListener('message', (e) => {
      const { id, message, metadata } = e.detail;
      console.log('message from', id, message, metadata);
    });

    receiver.addEventListener('connect', (e) => {
      const { id } = e.detail;
      console.log('peer connected', id);
    });

    // start listening in the same room as the sender
    receiver.start({ room: 'demo-room' });

    // stop when done
    // receiver.stop();

    // prepare local stream (browser)
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: true
    });

    // create sender
    const sender = new Sender({ driver });

    sender.addEventListener('open', (e) => {
      const { id } = e.detail;
      console.log('data channel opened', id);
      // send text data to the connected receiver
      sender.send('Hello from sender!');
    });
    sender.addEventListener('error', (e) => {
      const { id, error } = e.detail;
      console.error('sender error', id, error);
    });

    // start sender, provide local stream and room name
    sender.start({
      stream,
      room: 'demo-room',
      metadata: { name: 'Alice' },
      dataChannel: true, // create data channels for each receiver
    });

    // toggle audio/video at runtime
    sender.audioEnabled = false;
    sender.videoEnabled = true;

  </script>
</body>

</html>