!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).p2p={})}(this,function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}const i=[{urls:"stun:stun.l.google.com:19302"}];function n(e,t,i="video"){if(t?.length>0&&"function"==typeof e?.getTransceivers&&"RTCRtpSender"in window&&"RTCRtpTransceiver"in window&&"getCapabilities"in window.RTCRtpSender&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype){const n=e.getTransceivers().filter(e=>e?.sender?.track?.kind===i);if(!n.length)return;const s=RTCRtpSender.getCapabilities(i).codecs.filter(e=>t.includes(e.mimeType));if(!s.length)return;s.sort((e,i)=>t.indexOf(e.mimeType)-t.indexOf(i.mimeType)),n.forEach(e=>{e.setCodecPreferences(s)})}}class s extends EventTarget{constructor(e){super();const{driver:t,iceServers:n=i,connectionTimeout:s=30,queueSize:r=10,audioBitrate:o,videoBitrate:a,audioCodecs:d,videoCodecs:c}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=n,this.connectionTimeout=s,this.queueSize=r,this.audioBitrate=o,this.videoBitrate=a,this.audioCodecs=d,this.videoCodecs=c,this.connections=new Map,this.candidateQueues=new Map}get active(){return!!this._handler}start(e){if(this._handler)return;const{stream:i,room:s,state:r,dataChannel:o}=e||{};this.id=i?.id||t(),this.room=s||"default",this.state=r||{},this._handler=async e=>{const{type:t,id:s,candidate:r,answer:a}=e;if(t&&s&&s!==this.id)if("invoke"!==t){if("answer"===t&&a){const e=this.connections.get(s);if(!e)return;try{await e.peer.setRemoteDescription(new RTCSessionDescription(a))}catch(t){return void e.dispose(t)}if(this.candidateQueues.has(s)){for(const t of this.candidateQueues.get(s))try{await e.peer.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:s,error:e}}))}this.candidateQueues.delete(s)}return}if("candidate"===t&&r){const e=this.connections.get(s);if(!e)return this.candidateQueues.has(s)||this.candidateQueues.set(s,[]),void this.candidateQueues.get(s).push(r);try{await e.peer.addIceCandidate(new RTCIceCandidate(r))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:s,error:e}}))}return}}else{if(this.connections.has(s))return;try{const e={id:s,peer:new RTCPeerConnection({iceServers:this.iceServers}),dispose:i=>{clearTimeout(t),this.connections.delete(s),e.channel?.close(),e.peer?.close(),this.driver.emit(["receiver",this.room,s],{type:"dispose",id:this.id,state:this.state}),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:s,peer:e.peer,error:i}}))},queue:[]};this.connections.set(s,e);const t=this.connectionTimeout>0&&setTimeout(()=>e.dispose(new Error("Connection timeout")),1e3*this.connectionTimeout);e.peer.addEventListener("iceconnectionstatechange",i=>{const{iceConnectionState:n}=i.target;switch(n){case"connected":clearTimeout(t),this.dispatchEvent(new CustomEvent("connect",{detail:{id:s,peer:e.peer}}));break;case"disconnected":e.dispose();break;case"failed":e.dispose(new Error("ICE connection failed"))}}),e.peer.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["receiver",this.room,s],{type:"candidate",id:this.id,candidate:e.candidate})}),i&&(i.getTracks().forEach(t=>e.peer.addTrack(t,i)),function(e,t,i){if("function"==typeof e?.getSenders&&"RTCRtpSender"in window&&"getParameters"in window.RTCRtpSender.prototype&&"setParameters"in window.RTCRtpSender.prototype){const n={audio:0|t,video:0|i};e.getSenders().forEach(e=>{const t=n[e?.track.kind];if(!t)return;const i=e.getParameters();i.encodings||(i.encodings=[]);for(let e=0;e<i.encodings.length;e++){const n=i.encodings[e];n&&(n.maxBitrate=1e3*t)}e.setParameters(i)})}}(e.peer,this.audioBitrate,this.videoBitrate),n(e.peer,this.videoCodecs,"video"),n(e.peer,this.audioCodecs,"audio")),i&&!o||(e.channel=e.peer.createDataChannel(s),e.channel.addEventListener("open",()=>{for(;e.queue.length;){const t=e.queue.shift();e.channel.send(t)}},{once:!0}));const r=await e.peer.createOffer({offerToReceiveAudio:!!i&&i.getAudioTracks().length>0,offerToReceiveVideo:!!i&&i.getVideoTracks().length>0,iceRestart:!1});await e.peer.setLocalDescription(r),this.driver.emit(["receiver",this.room,s],{type:"offer",id:this.id,offer:r,state:this.state})}catch(e){const t=this.connections.get(s);t?t.dispose(e):this.dispatchEvent(new CustomEvent("error",{detail:{id:s,error:e}}))}}},this.driver.on(["sender",this.room],this._handler),this.driver.on(["sender",this.room,this.id],this._handler),this.driver.emit(["receiver",this.room],{type:"invoke",id:this.id})}stop(){if(this._handler){this.driver.off(["sender",this.room],this._handler),this.driver.off(["sender",this.room,this.id],this._handler);for(const e of this.connections.values())e.dispose();this.connections.clear(),this.candidateQueues.clear(),delete this._handler}}send(e,t){const i=(e,t)=>{"open"===e.channel?.readyState?e.channel.send(t):(e.queue.push(t),e.queue.length>this.queueSize&&e.queue.shift())};if(t){const n=this.connections.get(t);n&&i(n,e)}else for(const t of this.connections.values())i(t,e)}sync(e,t){t&&Object.assign(this.state,e);for(const e of this.connections.keys())this.driver.emit(["receiver",this.room,e],{type:"sync",id:this.id,state:this.state})}}class r extends EventTarget{constructor(e){super();const{driver:t,iceServers:n=i,connectionTimeout:s=30,pingInterval:r=30,reconnectAttempts:o=10}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=n,this.connectionTimeout=s,this.pingInterval=r,this.reconnectAttempts=o,this.connections=new Map,this.candidateQueues=new Map}get active(){return!!this._handler}start(e){if(this._handler)return;const{room:i}=e||{};this.id=t(),this.room=i||"default",this._handler=async e=>{const{type:t,id:i,offer:n,candidate:s,state:r}=e;if(t&&i&&this.id!==i)if("invoke"!==t)if("offer"===t&&n){if(this.connections.has(i))return;try{const e={id:i,peer:new RTCPeerConnection({iceServers:this.iceServers}),state:r,dispose:n=>{clearTimeout(t),this.connections.delete(i),e.channel?.close(),e.peer?.close(),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:i,peer:e.peer,error:n,state:e.state}}))}};this.connections.set(i,e);const t=this.connectionTimeout>0&&setTimeout(()=>e.dispose(new Error("Connection timeout")),1e3*this.connectionTimeout);if(e.peer.addEventListener("iceconnectionstatechange",n=>{const{iceConnectionState:s}=n.target;switch(s){case"connected":clearTimeout(t),this.dispatchEvent(new CustomEvent("connect",{detail:{id:i,peer:e.peer,state:e.state}}));break;case"disconnected":e.dispose();break;case"failed":e.dispose(new Error("ICE connection failed"))}}),e.peer.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["sender",this.room,i],{type:"candidate",id:this.id,candidate:e.candidate})}),e.peer.addEventListener("datachannel",t=>{e.channel||(e.channel=t.channel,e.channel.addEventListener("open",()=>{this.dispatchEvent(new CustomEvent("channel",{detail:{id:i,peer:e.peer,channel:e.channel,state:e.state}}))},{once:!0}),e.channel.addEventListener("message",t=>{const{data:n}=t;this.dispatchEvent(new CustomEvent("message",{detail:{id:i,peer:e.peer,message:n,state:e.state}}))}))},{once:!0}),e.peer.addEventListener("track",t=>{e.stream||(e.stream=t.streams[0],this.dispatchEvent(new CustomEvent("stream",{detail:{id:i,peer:e.peer,stream:e.stream,state:e.state}})))},{once:!0}),await e.peer.setRemoteDescription(new RTCSessionDescription(n)),this.candidateQueues.has(i)){for(const t of this.candidateQueues.get(i))try{await e.peer.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}this.candidateQueues.delete(i)}await e.peer.setLocalDescription(await e.peer.createAnswer()),this.driver.emit(["sender",this.room,i],{type:"answer",id:this.id,answer:e.peer.localDescription})}catch(e){const t=this.connections.get(i);t?t.dispose(e):this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}}else{if("candidate"===t&&s){const e=this.connections.get(i);if(!e)return this.candidateQueues.has(i)||this.candidateQueues.set(i,[]),void this.candidateQueues.get(i).push(s);try{await e.peer.addIceCandidate(new RTCIceCandidate(s))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}return}if("sync"===t){const e=this.connections.get(i);if(!e)return;return e.state=r,void this.dispatchEvent(new CustomEvent("sync",{detail:{id:i,peer:e.peer,state:e.state}}))}if("dispose"===t){const e=this.connections.get(i);if(!e)return;return void e.dispose()}}else{if(this.connections.has(i))return;this.driver.emit(["sender",this.room,i],{type:"invoke",id:this.id})}},this.driver.on(["receiver",this.room],this._handler),this.driver.on(["receiver",this.room,this.id],this._handler),this.driver.emit(["sender",this.room],{type:"invoke",id:this.id}),this._ping=0,this._timer=setInterval(()=>{this.connections.size>0&&(this._ping=this.reconnectAttempts),this._ping>0&&(this._ping--,this.driver.emit(["sender",this.room],{type:"invoke",id:this.id}))},1e3*this.pingInterval)}stop(){if(this._handler){clearInterval(this._timer),delete this._timer,this.driver.off(["receiver",this.room],this._handler),this.driver.off(["receiver",this.room,this.id],this._handler);for(const e of this.connections.values())e.dispose();this.connections.clear(),this.candidateQueues.clear(),delete this._handler}}}e.Receiver=r,e.Sender=s});
