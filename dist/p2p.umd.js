!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).p2p={})}(this,function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}const i=[{urls:"stun:stun.l.google.com:19302"}];class n extends EventTarget{constructor(e){super();const{driver:t,iceServers:n=i,verify:s,connectionTimeout:r=30,audioBitrate:a,videoBitrate:o}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=n,this.verify=s,this.connectionTimeout=r,this.audioBitrate=a,this.videoBitrate=o,this.connections=new Map,this.candidateQueues=new Map}get active(){return!!this._handler}start(e){if(this._handler)return;const{room:i,stream:n,metadata:s,channels:r}=e||{};this.id=n?.id||t(),this.room=i||"default",this._handler=async e=>{const{type:t,id:i,candidate:a,answer:o,credentials:d}=e;if(t&&i&&i!==this.id)if("invoke"!==t){if("answer"===t&&o){const e=this.connections.get(i);if(!e)return;try{await e.peer.setRemoteDescription(new RTCSessionDescription(o))}catch(t){return void e.dispose(t)}if(this.candidateQueues.has(i)){for(let t of this.candidateQueues.get(i))try{await e.peer.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}this.candidateQueues.delete(i)}return}if("candidate"===t&&a){const e=this.connections.get(i);if(!e)return this.candidateQueues.has(i)||this.candidateQueues.set(i,[]),void this.candidateQueues.get(i).push(a);try{await e.peer.addIceCandidate(new RTCIceCandidate(a))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}return}}else{if(this.connections.has(i))return;if(this.verify){if(!await this.verify({id:i,credentials:d}))return}try{const e={id:i,peer:new RTCPeerConnection({iceServers:this.iceServers}),dispose:n=>{clearTimeout(t),this.connections.delete(i),e.channels?.forEach(e=>e?.close()),e.peer?.close(),this.driver.emit(["receiver",this.room,i],{type:"dispose",id:this.id}),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:i,peer:e.peer,error:n}}))},channels:new Map};this.connections.set(i,e);const t=this.connectionTimeout>0&&setTimeout(()=>e.dispose(new Error("Connection timeout")),1e3*this.connectionTimeout);if(e.peer.addEventListener("iceconnectionstatechange",n=>{const{iceConnectionState:s}=n.target;switch(s){case"connected":clearTimeout(t),this.dispatchEvent(new CustomEvent("connect",{detail:{id:i,peer:e.peer}}));break;case"disconnected":e.dispose();break;case"failed":e.dispose(new Error("ICE connection failed"))}}),e.peer.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["receiver",this.room,i],{type:"candidate",id:this.id,candidate:e.candidate})}),n&&(n.getTracks().forEach(t=>e.peer.addTrack(t,n)),function(e,t,i){if("function"==typeof e?.getSenders&&"RTCRtpSender"in window&&"getParameters"in window.RTCRtpSender.prototype&&"setParameters"in window.RTCRtpSender.prototype){const n={audio:0|t,video:0|i};e.getSenders().forEach(e=>{const t=n[e?.track.kind];if(!t)return;const i=e.getParameters();i.encodings||(i.encodings=[]);for(let e=0;e<i.encodings.length;e++){const n=i.encodings[e];n&&(n.maxBitrate=1e3*t)}e.setParameters(i)})}}(e.peer,this.audioBitrate,this.videoBitrate)),r)for(let t in r){if(e.channels.has(t))continue;let n=r[t];if(!n)continue;"object"!=typeof n&&(n={});const s=e.peer.createDataChannel(t,n);e.channels.set(t,s),s.addEventListener("open",()=>{this.dispatchEvent(new CustomEvent("channel:open",{detail:{id:i,peer:e.peer,channel:s}}))},{once:!0}),s.addEventListener("close",()=>{this.dispatchEvent(new CustomEvent("channel:close",{detail:{id:i,peer:e.peer,channel:s}}))},{once:!0}),s.addEventListener("error",t=>{const{error:n}=t;this.dispatchEvent(new CustomEvent("channel:error",{detail:{id:i,peer:e.peer,channel:s,error:n}}))}),s.addEventListener("message",t=>{const{data:n}=t;this.dispatchEvent(new CustomEvent("channel:message",{detail:{id:i,peer:e.peer,channel:s,data:n}}))})}const a=await e.peer.createOffer({offerToReceiveAudio:!!n&&n.getAudioTracks().length>0,offerToReceiveVideo:!!n&&n.getVideoTracks().length>0,iceRestart:!1});await e.peer.setLocalDescription(a),this.driver.emit(["receiver",this.room,i],{type:"offer",id:this.id,offer:a,metadata:s})}catch(e){const t=this.connections.get(i);t?t.dispose(e):this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}}},this.driver.on(["sender",this.room],this._handler),this.driver.on(["sender",this.room,this.id],this._handler),this.driver.emit(["receiver",this.room],{type:"invoke",id:this.id})}stop(){if(this._handler){this.driver.off(["sender",this.room],this._handler),this.driver.off(["sender",this.room,this.id],this._handler);for(let e of this.connections.values())e.dispose();this.connections.clear(),this.candidateQueues.clear(),delete this._handler}}}class s extends EventTarget{constructor(e){super();const{driver:t,iceServers:n=i,connectionTimeout:s=30,pingInterval:r=30,pingAttempts:a=10}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=n,this.connectionTimeout=s,this.pingInterval=r,this.pingAttempts=a,this.connections=new Map,this.candidateQueues=new Map}get active(){return!!this._handler}start(e){if(this._handler)return;const{room:i,credentials:n}=e||{};this.id=t(),this.room=i||"default",this._handler=async e=>{const{type:t,id:i,offer:s,candidate:r,metadata:a}=e;if(t&&i&&this.id!==i)if("invoke"!==t)if("offer"===t&&s){if(this.connections.has(i))return;try{const e={id:i,peer:new RTCPeerConnection({iceServers:this.iceServers}),dispose:n=>{clearTimeout(t),this.connections.delete(i),e.channels?.forEach(e=>e?.close()),e.peer?.close(),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:i,peer:e.peer,error:n,metadata:a}}))},channels:new Map};this.connections.set(i,e);const t=this.connectionTimeout>0&&setTimeout(()=>e.dispose(new Error("Connection timeout")),1e3*this.connectionTimeout);if(e.peer.addEventListener("iceconnectionstatechange",n=>{const{iceConnectionState:s}=n.target;switch(s){case"connected":clearTimeout(t),this.dispatchEvent(new CustomEvent("connect",{detail:{id:i,peer:e.peer,metadata:a}}));break;case"disconnected":e.dispose();break;case"failed":e.dispose(new Error("ICE connection failed"))}}),e.peer.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["sender",this.room,i],{type:"candidate",id:this.id,candidate:e.candidate})}),e.peer.addEventListener("datachannel",t=>{const{channel:n}=t;e.channels.has(n.label)||(e.channels.set(n.label,n),n.addEventListener("open",()=>{this.dispatchEvent(new CustomEvent("channel:open",{detail:{id:i,peer:e.peer,channel:n,metadata:a}}))},{once:!0}),n.addEventListener("close",()=>{this.dispatchEvent(new CustomEvent("channel:close",{detail:{id:i,peer:e.peer,channel:n,metadata:a}}))},{once:!0}),n.addEventListener("error",t=>{const{error:s}=t;this.dispatchEvent(new CustomEvent("channel:error",{detail:{id:i,peer:e.peer,channel:n,error:s,metadata:a}}))}),n.addEventListener("message",t=>{const{data:s}=t;this.dispatchEvent(new CustomEvent("channel:message",{detail:{id:i,peer:e.peer,channel:n,data:s,metadata:a}}))}))}),e.peer.addEventListener("track",t=>{e.stream=t.streams[0],this.dispatchEvent(new CustomEvent("stream",{detail:{id:i,peer:e.peer,stream:e.stream,metadata:a}}))},{once:!0}),await e.peer.setRemoteDescription(new RTCSessionDescription(s)),this.candidateQueues.has(i)){for(let t of this.candidateQueues.get(i))try{await e.peer.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}this.candidateQueues.delete(i)}await e.peer.setLocalDescription(await e.peer.createAnswer()),this.driver.emit(["sender",this.room,i],{type:"answer",id:this.id,answer:e.peer.localDescription})}catch(e){const t=this.connections.get(i);t?t.dispose(e):this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}}else{if("candidate"===t&&r){const e=this.connections.get(i);if(!e)return this.candidateQueues.has(i)||this.candidateQueues.set(i,[]),void this.candidateQueues.get(i).push(r);try{await e.peer.addIceCandidate(new RTCIceCandidate(r))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}return}if("dispose"===t){const e=this.connections.get(i);if(!e)return;return void e.dispose()}}else{if(this.connections.has(i))return;this.driver.emit(["sender",this.room,i],{type:"invoke",id:this.id,credentials:n})}},this.driver.on(["receiver",this.room],this._handler),this.driver.on(["receiver",this.room,this.id],this._handler),this.driver.emit(["sender",this.room],{type:"invoke",id:this.id,credentials:n}),this.pingInterval>0&&this.pingAttempts>0&&(this._ping=this.pingAttempts,this._timer=setInterval(()=>{this.connections.size>0&&(this._ping=this.pingAttempts),this._ping>0&&(this._ping--,this.driver.emit(["sender",this.room],{type:"invoke",id:this.id,credentials:n}))},1e3*this.pingInterval))}stop(){if(this._handler){clearInterval(this._timer),delete this._timer,this.driver.off(["receiver",this.room],this._handler),this.driver.off(["receiver",this.room,this.id],this._handler);for(let e of this.connections.values())e.dispose();this.connections.clear(),this.candidateQueues.clear(),delete this._handler}}}e.Receiver=s,e.Sender=n});
