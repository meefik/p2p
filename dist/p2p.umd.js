!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).p2p={})}(this,function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}const i=[{urls:"stun:stun.l.google.com:19302"}];function s(e,t,i="video"){if(t?.length>0&&"function"==typeof e?.getTransceivers&&"RTCRtpReceiver"in window&&"RTCRtpTransceiver"in window&&"getCapabilities"in window.RTCRtpReceiver&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype){const s=e.getTransceivers().filter(e=>e.receiver.track.kind===i);if(!s.length)return;const n=RTCRtpReceiver.getCapabilities(i).codecs.filter(e=>t.includes(e.mimeType));if(!n.length)return;n.sort((e,i)=>t.indexOf(e.mimeType)-t.indexOf(i.mimeType)),s.forEach(e=>{e.setCodecPreferences(n)})}}class n extends EventTarget{constructor(e){super();const{driver:t,iceServers:s=i,audioBitrate:n=16,videoBitrate:r=64,audioCodecs:d=["audio/opus"],videoCodecs:a=["video/VP8","video/VP9"]}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=s,this.audioBitrate=n,this.videoBitrate=r,this.audioCodecs=d,this.videoCodecs=a,this.peers=new Map,this.channels=new Map,this.candidateQueues=new Map}start(e){if(this._handler)return;const{stream:i,room:n,metadata:r,dataChannel:d,audioEnabled:a,videoEnabled:o}=e||{};this.id=i?.id||t(),this.stream=i,this.room=n||"default",this.metadata=r,i&&("boolean"==typeof a&&i.getAudioTracks().forEach(e=>{e.enabled=!!a}),"boolean"==typeof o&&i.getVideoTracks().forEach(e=>{e.enabled=!!o})),this._handler=async e=>{const{type:t,id:n,candidate:r,answer:a}=e;if(t&&n&&n!==this.id){if("candidate"===t&&r){const e=this.peers.get(n);if(!e)return this.candidateQueues.has(n)||this.candidateQueues.set(n,[]),void this.candidateQueues.get(n).push(r);try{await e.addIceCandidate(new RTCIceCandidate(r))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:n,error:e}}))}return}if("answer"===t&&a){const e=this.peers.get(n);if(!e)return;try{await e.setRemoteDescription(new RTCSessionDescription(a))}catch(e){return this.dispose(n,e)}if(this.candidateQueues.has(n)){for(const t of this.candidateQueues.get(n))try{await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:n,error:e}}))}this.candidateQueues.delete(n)}return}if("invoke"!==t);else{if(this.peers.has(n))return;try{const e=new RTCPeerConnection({iceServers:this.iceServers});if(this.peers.set(n,e),e.addEventListener("iceconnectionstatechange",t=>{const{iceConnectionState:i}=t.target;switch(i){case"connected":this.dispatchEvent(new CustomEvent("connect",{detail:{id:n,peer:e}}));break;case"disconnected":{const e=new Error("ICE connection state is disconnected");this.dispose(n,e);break}case"failed":{const e=new Error("ICE connection state is failed");this.dispose(n,e);break}}}),e.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["receiver",this.room,n],{type:"candidate",id:this.id,candidate:e.candidate})}),i&&(i.getTracks().forEach(t=>e.addTrack(t,i)),function(e,t,i){if("function"==typeof e?.getSenders&&"RTCRtpSender"in window&&"getParameters"in window.RTCRtpSender.prototype&&"setParameters"in window.RTCRtpSender.prototype){const s={audio:0|t,video:0|i};e.getSenders().forEach(e=>{const t=s[e?.track.kind];if(!t)return;const i=e.getParameters();i.encodings||(i.encodings=[]);for(let e=0;e<i.encodings.length;e++){const s=i.encodings[e];s&&(s.maxBitrate=1e3*t)}e.setParameters(i)})}}(e,this.audioBitrate,this.videoBitrate),s(e,this.videoCodecs,"video"),s(e,this.audioCodecs,"audio")),!i||d){const t=e.createDataChannel(n);t.addEventListener("open",()=>{this.dispatchEvent(new CustomEvent("open",{detail:{id:n,channel:t}}))},{once:!0}),t.addEventListener("close",()=>{this.dispatchEvent(new CustomEvent("close",{detail:{id:n,channel:t}}))},{once:!0}),this.channels.set(n,t)}const t=await e.createOffer({offerToReceiveAudio:!!i&&i.getAudioTracks().length>0,offerToReceiveVideo:!!i&&i.getVideoTracks().length>0,iceRestart:!1});await e.setLocalDescription(t),this.driver.emit(["receiver",this.room,n],{type:"offer",id:this.id,offer:t,metadata:this.metadata,audioEnabled:this.audioEnabled,videoEnabled:this.videoEnabled})}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:n,error:e}}))}}}},this.driver.on(["sender",this.room],this._handler),this.driver.on(["sender",this.room,this.id],this._handler),this.driver.emit(["receiver",this.room],{type:"invoke",id:this.id})}stop(){if(this._handler){this.driver.off(["sender",this.room],this._handler),this.driver.off(["sender",this.room,this.id],this._handler);for(const e of this.channels.values())e.close();this.channels.clear();for(const[e,t]of this.peers)t.close(),this.driver.emit(["receiver",this.room,e],{type:"dispose",id:this.id}),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:e,peer:t}}));this.peers.clear(),this.candidateQueues.clear(),delete this._handler}}send(e){for(const t of this.channels.values())"open"===t.readyState&&t.send(e)}dispose(e,t){const i=this.channels.get(e);i&&(i.close(),this.channels.delete(e));const s=this.peers.get(e);s&&(s.close(),this.peers.delete(e),this.driver.emit(["receiver",this.room,e],{type:"dispose",id:this.id}),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:e,peer:s}}))),t&&this.dispatchEvent(new CustomEvent("error",{detail:{id:e,error:t}}))}get audioEnabled(){return!!this.stream&&this.stream.getAudioTracks().some(e=>e.enabled)}get videoEnabled(){return!!this.stream&&this.stream.getVideoTracks().some(e=>e.enabled)}set audioEnabled(e){this.stream&&this.audioEnabled!==!!e&&(this.stream?.getAudioTracks().forEach(t=>{t.enabled=!!e}),this.driver.emit(["receiver",this.room],{type:"change",id:this.id,audioEnabled:!!e}))}set videoEnabled(e){this.stream&&this.videoEnabled!==!!e&&(this.stream?.getVideoTracks().forEach(t=>{t.enabled=!!e}),this.driver.emit(["receiver",this.room],{type:"change",id:this.id,videoEnabled:!!e}))}}class r extends EventTarget{constructor(e){super();const{driver:t,iceServers:s=i,timeout:n=30,attempts:r=10}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=s,this.timeout=n,this.attempts=r,this.peers=new Map,this.channels=new Map,this.candidateQueues=new Map}start(e){if(this._handler)return;const{room:i}=e||{};this.id=t(),this.room=i||"default",this._handler=async e=>{const{type:t,id:i,offer:s,candidate:n,audioEnabled:r,videoEnabled:d,metadata:a}=e;if(t&&i&&this.id!==i)if("invoke"!==t)if("offer"===t&&s){if(this.peers.has(i))return;try{const e=new RTCPeerConnection({iceServers:this.iceServers});if(this.peers.set(i,e),e.addEventListener("iceconnectionstatechange",t=>{const{iceConnectionState:s}=t.target;switch(s){case"connected":this.dispatchEvent(new CustomEvent("connect",{detail:{id:i,peer:e}}));break;case"disconnected":{const e=new Error("ICE connection state is disconnected");this.dispose(i,e);break}case"failed":{const e=new Error("ICE connection state is failed");this.dispose(i,e);break}}}),e.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["sender",this.room,i],{type:"candidate",id:this.id,candidate:e.candidate})}),e.addEventListener("datachannel",e=>{if(this.channels.has(i))return;const{channel:t}=e;this.channels.set(i,t),t.addEventListener("open",()=>{this.dispatchEvent(new CustomEvent("open",{detail:{id:i,channel:t}}))},{once:!0}),t.addEventListener("close",()=>{this.dispatchEvent(new CustomEvent("close",{detail:{id:i,channel:t}}))},{once:!0}),t.addEventListener("message",e=>{const{data:t}=e;this.dispatchEvent(new CustomEvent("message",{detail:{id:i,message:t,metadata:a}}))})},{once:!0}),e.addEventListener("track",e=>{const[t]=e.streams;this.dispatchEvent(new CustomEvent("stream",{detail:{id:i,stream:t,audioEnabled:r,videoEnabled:d,metadata:a}}))},{once:!0}),await e.setRemoteDescription(new RTCSessionDescription(s)),this.candidateQueues.has(i)){for(const t of this.candidateQueues.get(i))try{await e.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}this.candidateQueues.delete(i)}await e.setLocalDescription(await e.createAnswer()),this.driver.emit(["sender",this.room,i],{type:"answer",id:this.id,answer:e.localDescription})}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}}else{if("candidate"===t&&n){const e=this.peers.get(i);if(!e)return this.candidateQueues.has(i)||this.candidateQueues.set(i,[]),void this.candidateQueues.get(i).push(n);try{await e.addIceCandidate(new RTCIceCandidate(n))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}return}if("change"===t){if(!this.peers.get(i))return;return void this.dispatchEvent(new CustomEvent("change",{detail:{id:i,audioEnabled:r,videoEnabled:d}}))}"dispose"!==t||this.dispose(i)}else{if(this.peers.has(i))return;try{this.driver.emit(["sender",this.room,i],{type:"invoke",id:this.id})}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}}},this.driver.on(["receiver",this.room],this._handler),this.driver.on(["receiver",this.room,this.id],this._handler),this.driver.emit(["sender",this.room],{type:"invoke",id:this.id}),this._ping=0,this._timer=setInterval(()=>{this.peers.size>0&&(this._ping=this.attempts),this._ping>0&&(this._ping--,this.driver.emit(["sender",this.room],{type:"invoke",id:this.id}))},1e3*this.timeout)}stop(){if(this._handler){clearInterval(this._timer),delete this._timer,this.driver.off(["receiver",this.room],this._handler),this.driver.off(["receiver",this.room,this.id],this._handler);for(const e of this.channels.values())e.close();this.channels.clear();for(const[e,t]of this.peers)t.close(),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:e,peer:t}}));this.peers.clear(),this.candidateQueues.clear(),delete this._handler}}dispose(e,t){const i=this.channels.get(e);i&&(i.close(),this.channels.delete(e));const s=this.peers.get(e);s&&(s.close(),this.peers.delete(e),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:e,peer:s}}))),t&&this.dispatchEvent(new CustomEvent("error",{detail:{id:e,error:t}}))}}e.Receiver=r,e.Sender=n});
