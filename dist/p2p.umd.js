!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).p2p={})}(this,function(e){"use strict";function t(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}const i=[{urls:"stun:stun.l.google.com:19302"}];class s extends EventTarget{constructor(e){super();const{driver:t,iceServers:s=i,verify:n,connectionTimeout:r=30,queueSize:o=10,audioBitrate:a,videoBitrate:d}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=s,this.verify=n,this.connectionTimeout=r,this.queueSize=o,this.audioBitrate=a,this.videoBitrate=d,this.connections=new Map,this.candidateQueues=new Map}get active(){return!!this._handler}start(e){if(this._handler)return;const{stream:i,room:s,state:n,dataChannel:r}=e||{};this.id=i?.id||t(),this.room=s||"default",this.state=n||{},this._handler=async e=>{const{type:t,id:s,candidate:n,answer:o,credentials:a}=e;if(t&&s&&s!==this.id)if("invoke"!==t){if("answer"===t&&o){const e=this.connections.get(s);if(!e)return;try{await e.peer.setRemoteDescription(new RTCSessionDescription(o))}catch(t){return void e.dispose(t)}if(this.candidateQueues.has(s)){for(const t of this.candidateQueues.get(s))try{await e.peer.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:s,error:e}}))}this.candidateQueues.delete(s)}return}if("candidate"===t&&n){const e=this.connections.get(s);if(!e)return this.candidateQueues.has(s)||this.candidateQueues.set(s,[]),void this.candidateQueues.get(s).push(n);try{await e.peer.addIceCandidate(new RTCIceCandidate(n))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:s,error:e}}))}return}}else{if(this.connections.has(s))return;if(this.verify){if(!await this.verify(s,a))return}try{const e={id:s,peer:new RTCPeerConnection({iceServers:this.iceServers}),dispose:i=>{clearTimeout(t),this.connections.delete(s),e.channel?.close(),e.peer?.close(),this.driver.emit(["receiver",this.room,s],{type:"dispose",id:this.id,state:this.state}),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:s,peer:e.peer,error:i}}))},queue:[]};this.connections.set(s,e);const t=this.connectionTimeout>0&&setTimeout(()=>e.dispose(new Error("Connection timeout")),1e3*this.connectionTimeout);e.peer.addEventListener("iceconnectionstatechange",i=>{const{iceConnectionState:n}=i.target;switch(n){case"connected":clearTimeout(t),this.dispatchEvent(new CustomEvent("connect",{detail:{id:s,peer:e.peer}}));break;case"disconnected":e.dispose();break;case"failed":e.dispose(new Error("ICE connection failed"))}}),e.peer.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["receiver",this.room,s],{type:"candidate",id:this.id,candidate:e.candidate})}),i&&(i.getTracks().forEach(t=>e.peer.addTrack(t,i)),function(e,t,i){if("function"==typeof e?.getSenders&&"RTCRtpSender"in window&&"getParameters"in window.RTCRtpSender.prototype&&"setParameters"in window.RTCRtpSender.prototype){const s={audio:0|t,video:0|i};e.getSenders().forEach(e=>{const t=s[e?.track.kind];if(!t)return;const i=e.getParameters();i.encodings||(i.encodings=[]);for(let e=0;e<i.encodings.length;e++){const s=i.encodings[e];s&&(s.maxBitrate=1e3*t)}e.setParameters(i)})}}(e.peer,this.audioBitrate,this.videoBitrate)),i&&!r||(e.channel=e.peer.createDataChannel(s),e.channel.addEventListener("open",()=>{for(;e.queue.length;){const t=e.queue.shift();e.channel.send(t)}},{once:!0}));const n=await e.peer.createOffer({offerToReceiveAudio:!!i&&i.getAudioTracks().length>0,offerToReceiveVideo:!!i&&i.getVideoTracks().length>0,iceRestart:!1});await e.peer.setLocalDescription(n),this.driver.emit(["receiver",this.room,s],{type:"offer",id:this.id,offer:n,state:this.state})}catch(e){const t=this.connections.get(s);t?t.dispose(e):this.dispatchEvent(new CustomEvent("error",{detail:{id:s,error:e}}))}}},this.driver.on(["sender",this.room],this._handler),this.driver.on(["sender",this.room,this.id],this._handler),this.driver.emit(["receiver",this.room],{type:"invoke",id:this.id})}stop(){if(this._handler){this.driver.off(["sender",this.room],this._handler),this.driver.off(["sender",this.room,this.id],this._handler);for(const e of this.connections.values())e.dispose();this.connections.clear(),this.candidateQueues.clear(),delete this._handler}}send(e,t){const i=(e,t)=>{"open"===e.channel?.readyState?e.channel.send(t):(e.queue.push(t),e.queue.length>this.queueSize&&e.queue.shift())};if(t){const s=this.connections.get(t);s&&i(s,e)}else for(const t of this.connections.values())i(t,e)}sync(e,t){t&&Object.assign(this.state,e);for(const e of this.connections.keys())this.driver.emit(["receiver",this.room,e],{type:"sync",id:this.id,state:this.state})}}class n extends EventTarget{constructor(e){super();const{driver:t,iceServers:s=i,connectionTimeout:n=30,pingInterval:r=30,pingAttempts:o=10}=e||{};if(!t)throw new Error("Missing driver");this.driver=t,this.iceServers=s,this.connectionTimeout=n,this.pingInterval=r,this.pingAttempts=o,this.connections=new Map,this.candidateQueues=new Map}get active(){return!!this._handler}start(e){if(this._handler)return;const{room:i,credentials:s}=e||{};this.id=t(),this.room=i||"default",this._handler=async e=>{const{type:t,id:i,offer:n,candidate:r,state:o}=e;if(t&&i&&this.id!==i)if("invoke"!==t)if("offer"===t&&n){if(this.connections.has(i))return;try{const e={id:i,peer:new RTCPeerConnection({iceServers:this.iceServers}),state:o,dispose:s=>{clearTimeout(t),this.connections.delete(i),e.channel?.close(),e.peer?.close(),this.dispatchEvent(new CustomEvent("dispose",{detail:{id:i,peer:e.peer,error:s,state:e.state}}))}};this.connections.set(i,e);const t=this.connectionTimeout>0&&setTimeout(()=>e.dispose(new Error("Connection timeout")),1e3*this.connectionTimeout);if(e.peer.addEventListener("iceconnectionstatechange",s=>{const{iceConnectionState:n}=s.target;switch(n){case"connected":clearTimeout(t),this.dispatchEvent(new CustomEvent("connect",{detail:{id:i,peer:e.peer,state:e.state}}));break;case"disconnected":e.dispose();break;case"failed":e.dispose(new Error("ICE connection failed"))}}),e.peer.addEventListener("icecandidate",e=>{e?.candidate&&this.driver.emit(["sender",this.room,i],{type:"candidate",id:this.id,candidate:e.candidate})}),e.peer.addEventListener("datachannel",t=>{e.channel||(e.channel=t.channel,e.channel.addEventListener("open",()=>{this.dispatchEvent(new CustomEvent("channel",{detail:{id:i,peer:e.peer,channel:e.channel,state:e.state}}))},{once:!0}),e.channel.addEventListener("message",t=>{const{data:s}=t;this.dispatchEvent(new CustomEvent("message",{detail:{id:i,peer:e.peer,message:s,state:e.state}}))}))},{once:!0}),e.peer.addEventListener("track",t=>{e.stream||(e.stream=t.streams[0],this.dispatchEvent(new CustomEvent("stream",{detail:{id:i,peer:e.peer,stream:e.stream,state:e.state}})))},{once:!0}),await e.peer.setRemoteDescription(new RTCSessionDescription(n)),this.candidateQueues.has(i)){for(const t of this.candidateQueues.get(i))try{await e.peer.addIceCandidate(new RTCIceCandidate(t))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}this.candidateQueues.delete(i)}await e.peer.setLocalDescription(await e.peer.createAnswer()),this.driver.emit(["sender",this.room,i],{type:"answer",id:this.id,answer:e.peer.localDescription})}catch(e){const t=this.connections.get(i);t?t.dispose(e):this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}}else{if("candidate"===t&&r){const e=this.connections.get(i);if(!e)return this.candidateQueues.has(i)||this.candidateQueues.set(i,[]),void this.candidateQueues.get(i).push(r);try{await e.peer.addIceCandidate(new RTCIceCandidate(r))}catch(e){this.dispatchEvent(new CustomEvent("error",{detail:{id:i,error:e}}))}return}if("sync"===t){const e=this.connections.get(i);if(!e)return;return e.state=o,void this.dispatchEvent(new CustomEvent("sync",{detail:{id:i,peer:e.peer,state:e.state}}))}if("dispose"===t){const e=this.connections.get(i);if(!e)return;return void e.dispose()}}else{if(this.connections.has(i))return;this.driver.emit(["sender",this.room,i],{type:"invoke",id:this.id,credentials:s})}},this.driver.on(["receiver",this.room],this._handler),this.driver.on(["receiver",this.room,this.id],this._handler),this.driver.emit(["sender",this.room],{type:"invoke",id:this.id,credentials:s}),this._ping=0,this._timer=setInterval(()=>{this.connections.size>0&&(this._ping=this.pingAttempts),this._ping>0&&(this._ping--,this.driver.emit(["sender",this.room],{type:"invoke",id:this.id,credentials:s}))},1e3*this.pingInterval)}stop(){if(this._handler){clearInterval(this._timer),delete this._timer,this.driver.off(["receiver",this.room],this._handler),this.driver.off(["receiver",this.room,this.id],this._handler);for(const e of this.connections.values())e.dispose();this.connections.clear(),this.candidateQueues.clear(),delete this._handler}}}e.Receiver=n,e.Sender=s});
